Feature: vsftpd/config.pp
  In order to vsftpdor services on a system. This define must take a hash of
  configs to install and create them.

    Scenario: vsftpd::config default
    Given a node named "vsftpd-config-default"
    When I compile the catalog
    Then compilation should succeed
    And all resource dependencies should resolve
    And file "/etc/vsftpd.conf" should be "present"
      And the file should contain "listen=YES"
      And the file should contain "#listen_address=0.0.0.0"
      And the file should contain "listen_port=21"
      And the file should contain "listen_ipv6=NO"
      And the file should contain "#listen_address6="
      And the file should contain "max_clients=0"
      And the file should contain "max_login_fails=3"
      And the file should contain "max_per_ip=0"
      And the file should contain "anonymous_enable=NO"
      And the file should contain "no_anon_password=NO"
      And the file should contain "anon_mkdir_write_enable=NO"
      And the file should contain "anon_other_write_enable=NO"
      And the file should contain "anon_world_readable_only=YES"
      And the file should contain "anon_upload_enable=NO"
      And the file should contain "anon_max_rate=0"
      And the file should contain "anon_umask=077"
      And the file should contain "#anon_root="
      And the file should contain "local_enable=NO"
      And the file should contain "#local_root="
      And the file should contain "text_userdb_names=NO"
      And the file should contain "tilde_user_enable=NO"
      And the file should contain "hide_ids=NO"
      And the file should contain "#hide_file="
      And the file should contain "#deny_file="
      And the file should contain "#cmds_allowed="
      And the file should contain "#cmds_denied="
      And the file should contain "guest_enable=NO"
      And the file should contain "guest_username=ftp"
      And the file should contain "#user_sub_token="
      And the file should contain "#user_config_dir="
      And the file should contain "write_enable=NO"
      And the file should contain "lock_upload_files=YES"
      And the file should contain "local_umask=077"
      And the file should contain "local_max_rate=0"
      And the file should contain "delete_failed_uploads=NO"
      And the file should contain "dirlist_enable=YES"
      And the file should contain "dirmessage_enable=YES"
      And the file should contain "message_file=.message"
      And the file should contain "force_dot_files=NO"
      And the file should contain "use_localtime=YES"
      And the file should contain "xferlog_enable=YES"
      And the file should contain "xferlog_file=/var/log/xferlog"
      And the file should contain "vsftpd_log_file=/var/log/vsftpd.log"
      And the file should contain "xferlog_std_format=NO"
      And the file should contain "dual_log_enable=NO"
      And the file should contain "log_ftp_protocol=NO"
      And the file should contain "no_log_lock=NO"
      And the file should contain "syslog_enable=NO"
      And the file should contain "tcp_wrappers=NO"
      And the file should contain "connect_from_port_20=YES"
      And the file should contain "ftp_data_port=20"
      And the file should contain "port_enable=YES"
      And the file should contain "port_promiscuous=NO"
      And the file should contain "pasv_enable=YES"
      And the file should contain "pasv_min_port=0"
      And the file should contain "pasv_max_port=0"
      And the file should contain "pasv_promiscuous=NO"
      And the file should contain "#pasv_address="
      And the file should contain "pasv_addr_resolve=NO"
      And the file should contain "chmod_enable=YES"
      And the file should contain "chown_uploads=NO"
      And the file should contain "chown_upload_mode=0600"
      And the file should contain "file_open_mode=0666"
      And the file should contain "mdtm_write=YES"
      And the file should contain "chown_username=root"
      And the file should contain "accept_timeout=60"
      And the file should contain "connect_timeout=60"
      And the file should contain "idle_session_timeout=600"
      And the file should contain "data_connection_timeout=120"
      And the file should contain "delay_failed_login=1"
      And the file should contain "delay_successful_login=0"
      And the file should contain "session_support=NO"
      And the file should contain "trans_chunk_size=0"
      And the file should contain "setproctitle_enable=NO"
      And the file should contain "use_sendfile=YES"
      And the file should contain "nopriv_user=nobody"
      And the file should contain "async_abor_enable=NO"
      And the file should contain "ascii_upload_enable=NO"
      And the file should contain "ascii_download_enable=NO"
      And the file should contain "download_enable=YES"
      And the file should contain "ftp_username=ftp"
      And the file should contain "#ftpd_banner=Welcome to blah FTP service."
      And the file should contain "#banner_file="
      And the file should contain "background=NO"
      And the file should contain "run_as_launching_user=NO"
      And the file should contain "deny_email_enable=NO"
      And the file should contain "banned_email_file=/etc/vsftpd.d/vsftpd.banned_emails"
      And the file should contain "secure_email_list_enable=NO"
      And the file should contain "email_password_file=/etc/vsftpd.d/vsftpd.email_passwords"
      And the file should contain "userlist_enable=NO"
      And the file should contain "userlist_deny=YES"
      And the file should contain "userlist_file=/etc/vsftpd.d/vsftpd.userlist_file"
      And the file should contain "chroot_local_user=NO"
      And the file should contain "passwd_chroot_enable=NO"
      And the file should contain "chroot_list_enable=NO"
      And the file should contain "chroot_list_file=/etc/vsftpd.d/vsftpd.chroot_list"
      And the file should contain "virtual_use_local_privs=NO"
      And the file should contain "ls_recurse_enable=NO"
      And the file should contain "secure_chroot_dir=/var/run/vsftpd/empty"
      And the file should contain "pam_service_name=vsftpd"
      And the file should contain "check_shell=NO"
      And the file should contain "ssl_enable=NO"
      And the file should contain "debug_ssl=NO"
      And the file should contain "ssl_request_cert=YES"
      And the file should contain "require_cert=NO"
      And the file should contain "require_ssl_reuse=YES"
      And the file should contain "implicit_ssl=NO"
      And the file should contain "allow_anon_ssl=NO"
      And the file should contain "force_anon_data_ssl=NO"
      And the file should contain "force_anon_logins_ssl=NO"
      And the file should contain "force_local_data_ssl=YES"
      And the file should contain "force_local_logins_ssl=YES"
      And the file should contain "ssl_sslv2=NO"
      And the file should contain "ssl_sslv3=NO"
      And the file should contain "ssl_tlsv1=YES"
      And the file should contain "#ca_certs_file="
      And the file should contain "validate_cert=NO"
      And the file should contain "strict_ssl_read_eof=NO"
      And the file should contain "strict_ssl_write_shutdown=NO"
      And the file should contain "rsa_cert_file=/etc/ssl/private/vsftpd.pem"
      And the file should contain "#rsa_private_key_file=/etc/ssl/private/vsftpd.pem"
      And the file should contain "#dsa_cert_file=/etc/ssl/private/vsftpd.pem"
      And the file should contain "#dsa_private_key_file=/etc/ssl/private/vsftpd.pem"
      And the file should contain "#ssl_ciphers=DES-CBC3-SHA"
    And file "/etc/default/vsftpd" should be "present"
    And following directories should be created:
      | name          |
      | /etc/vsftpd.d |
    And file "/etc/vsftpd.d/vsftpd.chroot_users" should be "present"
    And file "/etc/vsftpd.d/vsftpd.banned_emails" should be "present"
    And file "/etc/vsftpd.d/vsftpd.email_passwords" should be "present"
    And file "/etc/vsftpd.d/vsftpd.userlist_file" should be "present"

    Scenario: vsftpd::config from facts
    Given a node named "vsftpd-config-from-facts"
    And a fact "vsftpd_chroot_users" of "foo,bar,baz"
    And a fact "vsftpd_banned_emails" of "evil@hacker.com"
    And a fact "vsftpd_email_passwords" of "easy,pass"
    And a fact "vsftpd_users_list" of "fred,jane,john"
    And a fact "vsftpd_listen" of "false"
    And a fact "vsftpd_listen_address" of "127.0.0.1"
    And a fact "vsftpd_listen_port" of "22"
    And a fact "vsftpd_listen_ipv6" of "true"
    And a fact "vsftpd_listen_address6" of "::1"
    And a fact "vsftpd_max_clients" of "20"
    And a fact "vsftpd_max_login_fails" of "6"
    And a fact "vsftpd_max_per_ip" of "6"
    And a fact "vsftpd_anonymous_enable" of "true"
    And a fact "vsftpd_no_anon_password" of "true"
    And a fact "vsftpd_anon_mkdir_write_enable" of "true"
    And a fact "vsftpd_anon_other_write_enable" of "true"
    And a fact "vsftpd_anon_world_readable_only" of "false"
    And a fact "vsftpd_anon_upload_enable" of "true"
    And a fact "vsftpd_anon_max_rate" of "6"
    And a fact "vsftpd_anon_umask" of "007"
    And a fact "vsftpd_anon_root" of "/home/anon"
    And a fact "vsftpd_local_enable" of "true"
    And a fact "vsftpd_local_root" of "/home/virtual"
    And a fact "vsftpd_text_userdb_names" of "true"
    And a fact "vsftpd_tilde_user_enable" of "true"
    And a fact "vsftpd_hide_ids" of "true"
    And a fact "vsftpd_hide_file" of "{.private}"
    And a fact "vsftpd_deny_file" of "{.private}"
    And a fact "vsftpd_cmds_allowed" of "PUT,DELETE,GET"
    And a fact "vsftpd_cmds_denied" of "LIST"
    And a fact "vsftpd_guest_enable" of "true"
    And a fact "vsftpd_guest_username" of "/home/virtual/$USER"
    And a fact "vsftpd_user_sub_token" of "$USER"
    And a fact "vsftpd_user_config_dir" of "/etc/vsftpd.d"
    And a fact "vsftpd_write_enable" of "true"
    And a fact "vsftpd_lock_upload_files" of "false"
    And a fact "vsftpd_local_umask" of "007"
    And a fact "vsftpd_local_max_rate" of "1000"
    And a fact "vsftpd_delete_failed_uploads" of "true"
    And a fact "vsftpd_dirlist_enable" of "false"
    And a fact "vsftpd_dirmessage_enable" of "false"
    And a fact "vsftpd_message_file" of ".login"
    And a fact "vsftpd_force_dot_files" of "true"
    And a fact "vsftpd_use_localtime" of "false"
    And a fact "vsftpd_xferlog_enable" of "false"
    And a fact "vsftpd_xferlog_file" of "/tmp/xfer.log"
    And a fact "vsftpd_log_file" of "/tmp/vsftpd.log"
    And a fact "vsftpd_xferlog_std_format" of "true"
    And a fact "vsftpd_dual_log_enable" of "true"
    And a fact "vsftpd_log_ftp_protocol" of "true"
    And a fact "vsftpd_no_log_lock" of "true"
    And a fact "vsftpd_syslog_enable" of "true"
    And a fact "vsftpd_tcp_wrappers" of "true"
    And a fact "vsftpd_connect_from_port_20" of "false"
    And a fact "vsftpd_ftp_data_port" of "21"
    And a fact "vsftpd_port_enable" of "false"
    And a fact "vsftpd_port_promiscuous" of "true"
    And a fact "vsftpd_pasv_enable" of "false"
    And a fact "vsftpd_pasv_min_port" of "1200"
    And a fact "vsftpd_pasv_max_port" of "1300"
    And a fact "vsftpd_pasv_promiscuous" of "true"
    And a fact "vsftpd_pasv_address" of "169.254.169.254"
    And a fact "vsftpd_pasv_addr_resolve" of "true"
    And a fact "vsftpd_chmod_enable" of "false"
    And a fact "vsftpd_chown_uploads" of "true"
    And a fact "vsftpd_chown_upload_mode" of "0660"
    And a fact "vsftpd_file_open_mode" of "0660"
    And a fact "vsftpd_mdtm_write" of "false"
    And a fact "vsftpd_chown_username" of "ftp"
    And a fact "vsftpd_accept_timeout" of "120"
    And a fact "vsftpd_connect_timeout" of "120"
    And a fact "vsftpd_idle_session_timeout" of "900"
    And a fact "vsftpd_data_connection_timeout" of "180"
    And a fact "vsftpd_delay_failed_login" of "2"
    And a fact "vsftpd_delay_successful_login" of "1"
    And a fact "vsftpd_session_support" of "true"
    And a fact "vsftpd_trans_chunk_size" of "8192"
    And a fact "vsftpd_setproctitle_enable" of "true"
    And a fact "vsftpd_use_sendfile" of "false"
    And a fact "vsftpd_nopriv_user" of "ftpsecure"
    And a fact "vsftpd_async_abor_enable" of "true"
    And a fact "vsftpd_ascii_upload_enable" of "true"
    And a fact "vsftpd_ascii_download_enable" of "true"
    And a fact "vsftpd_download_enable" of "false"
    And a fact "vsftpd_ftp_username" of "ftpd"
    And a fact "vsftpd_ftpd_banner" of "Welcome"
    And a fact "vsftpd_banner_file" of "/etc/motd"
    And a fact "vsftpd_background" of "true"
    And a fact "vsftpd_run_as_launching_user" of "true"
    And a fact "vsftpd_deny_email_enable" of "true"
    And a fact "vsftpd_banned_email_file" of "/tmp/ban"
    And a fact "vsftpd_secure_email_list_enable" of "true"
    And a fact "vsftpd_email_password_file" of "/tmp/email.pass"
    And a fact "vsftpd_userlist_enable" of "true"
    And a fact "vsftpd_userlist_deny" of "false"
    And a fact "vsftpd_userlist_file" of "/tmp/user.list"
    And a fact "vsftpd_chroot_local_user" of "true"
    And a fact "vsftpd_passwd_chroot_enable" of "true"
    And a fact "vsftpd_chroot_list_enable" of "true"
    And a fact "vsftpd_chroot_list_file" of "/tmp/chroot.list"
    And a fact "vsftpd_virtual_use_local_privs" of "true"
    And a fact "vsftpd_ls_recurse_enable" of "true"
    And a fact "vsftpd_secure_chroot_dir" of "/tmp/empty"
    And a fact "vsftpd_pam_service_name" of "ftpd"
    And a fact "vsftpd_check_shell" of "true"
    And a fact "vsftpd_ssl_enable" of "true"
    And a fact "vsftpd_debug_ssl" of "true"
    And a fact "vsftpd_ssl_request_cert" of "false"
    And a fact "vsftpd_require_cert" of "true"
    And a fact "vsftpd_require_ssl_reuse" of "false"
    And a fact "vsftpd_implicit_ssl" of "true"
    And a fact "vsftpd_allow_anon_ssl" of "true"
    And a fact "vsftpd_force_anon_data_ssl" of "true"
    And a fact "vsftpd_force_anon_logins_ssl" of "true"
    And a fact "vsftpd_force_local_data_ssl" of "false"
    And a fact "vsftpd_force_local_logins_ssl" of "false"
    And a fact "vsftpd_ssl_sslv2" of "true"
    And a fact "vsftpd_ssl_sslv3" of "true"
    And a fact "vsftpd_ssl_tlsv1" of "false"
    And a fact "vsftpd_ca_certs_file" of "/tmp/certs"
    And a fact "vsftpd_validate_cert" of "true"
    And a fact "vsftpd_strict_ssl_read_eof" of "true"
    And a fact "vsftpd_strict_ssl_write_shutdown" of "true"
    And a fact "vsftpd_rsa_cert_file" of "/tmp/cert.pem"
    And a fact "vsftpd_rsa_private_key_file" of "/tmp/prv.pem"
    And a fact "vsftpd_dsa_cert_file" of "/tmp/cert.pem"
    And a fact "vsftpd_dsa_private_key_file" of "/tmp/prv.pem"
    And a fact "vsftpd_ssl_ciphers" of "3DES"
    When I compile the catalog
    Then compilation should succeed
    And all resource dependencies should resolve
    And file "/etc/vsftpd.conf" should be "present"
      And the file should contain "listen=NO"
      And the file should contain "listen_address=127.0.0.1"
      And the file should contain "listen_port=22"
      And the file should contain "listen_ipv6=YES"
      And the file should contain "listen_address6=::1"
      And the file should contain "max_clients=20"
      And the file should contain "max_login_fails=6"
      And the file should contain "max_per_ip=6"
      And the file should contain "anonymous_enable=YES"
      And the file should contain "no_anon_password=YES"
      And the file should contain "anon_mkdir_write_enable=YES"
      And the file should contain "anon_other_write_enable=YES"
      And the file should contain "anon_world_readable_only=NO"
      And the file should contain "anon_upload_enable=YES"
      And the file should contain "anon_max_rate=6"
      And the file should contain "anon_umask=007"
      And the file should contain "anon_root=/home/anon"
      And the file should contain "local_enable=YES"
      And the file should contain "local_root=/home/virtual"
      And the file should contain "text_userdb_names=YES"
      And the file should contain "tilde_user_enable=YES"
      And the file should contain "hide_ids=YES"
      And the file should contain "hide_file={.private}"
      And the file should contain "deny_file={.private}"
      And the file should contain "cmds_allowed=PUT,DELETE,GET"
      And the file should contain "cmds_denied=LIST"
      And the file should contain "guest_enable=YES"
      And the file should contain "guest_username=/home/virtual/$USER"
      And the file should contain "user_sub_token=$USER"
      And the file should contain "user_config_dir=/etc/vsftpd.d"
      And the file should contain "write_enable=YES"
      And the file should contain "lock_upload_files=NO"
      And the file should contain "local_umask=007"
      And the file should contain "local_max_rate=1000"
      And the file should contain "delete_failed_uploads=YES"
      And the file should contain "dirlist_enable=NO"
      And the file should contain "dirmessage_enable=NO"
      And the file should contain "message_file=.login"
      And the file should contain "force_dot_files=YES"
      And the file should contain "use_localtime=NO"
      And the file should contain "xferlog_enable=NO"
      And the file should contain "xferlog_file=/tmp/xfer.log"
      And the file should contain "vsftpd_log_file=/tmp/vsftpd.log"
      And the file should contain "xferlog_std_format=YES"
      And the file should contain "dual_log_enable=YES"
      And the file should contain "log_ftp_protocol=YES"
      And the file should contain "no_log_lock=YES"
      And the file should contain "syslog_enable=YES"
      And the file should contain "tcp_wrappers=YES"
      And the file should contain "connect_from_port_20=NO"
      And the file should contain "ftp_data_port=21"
      And the file should contain "port_enable=NO"
      And the file should contain "port_promiscuous=YES"
      And the file should contain "pasv_enable=NO"
      And the file should contain "pasv_min_port=1200"
      And the file should contain "pasv_max_port=1300"
      And the file should contain "pasv_promiscuous=YES"
      And the file should contain "pasv_address=169.254.169.254"
      And the file should contain "pasv_addr_resolve=YES"
      And the file should contain "chmod_enable=NO"
      And the file should contain "chown_uploads=YES"
      And the file should contain "chown_upload_mode=0660"
      And the file should contain "file_open_mode=0660"
      And the file should contain "mdtm_write=NO"
      And the file should contain "chown_username=ftp"
      And the file should contain "accept_timeout=120"
      And the file should contain "connect_timeout=120"
      And the file should contain "idle_session_timeout=900"
      And the file should contain "data_connection_timeout=180"
      And the file should contain "delay_failed_login=2"
      And the file should contain "delay_successful_login=1"
      And the file should contain "session_support=YES"
      And the file should contain "trans_chunk_size=8192"
      And the file should contain "setproctitle_enable=YES"
      And the file should contain "use_sendfile=NO"
      And the file should contain "nopriv_user=ftpsecure"
      And the file should contain "async_abor_enable=YES"
      And the file should contain "ascii_upload_enable=YES"
      And the file should contain "ascii_download_enable=YES"
      And the file should contain "download_enable=NO"
      And the file should contain "ftp_username=ftpd"
      And the file should contain "ftpd_banner=Welcome"
      And the file should contain "banner_file=/etc/motd"
      And the file should contain "background=YES"
      And the file should contain "run_as_launching_user=YES"
      And the file should contain "deny_email_enable=YES"
      And the file should contain "banned_email_file=/tmp/ban"
      And the file should contain "secure_email_list_enable=YES"
      And the file should contain "email_password_file=/tmp/email.pass"
      And the file should contain "userlist_enable=YES"
      And the file should contain "userlist_deny=NO"
      And the file should contain "userlist_file=/tmp/user.list"
      And the file should contain "chroot_local_user=YES"
      And the file should contain "passwd_chroot_enable=YES"
      And the file should contain "chroot_list_enable=YES"
      And the file should contain "chroot_list_file=/tmp/chroot.list"
      And the file should contain "virtual_use_local_privs=YES"
      And the file should contain "ls_recurse_enable=YES"
      And the file should contain "secure_chroot_dir=/tmp/empty"
      And the file should contain "pam_service_name=ftpd"
      And the file should contain "check_shell=YES"
      And the file should contain "ssl_enable=YES"
      And the file should contain "debug_ssl=YES"
      And the file should contain "ssl_request_cert=NO"
      And the file should contain "require_cert=YES"
      And the file should contain "require_ssl_reuse=NO"
      And the file should contain "implicit_ssl=YES"
      And the file should contain "allow_anon_ssl=YES"
      And the file should contain "force_anon_data_ssl=YES"
      And the file should contain "force_anon_logins_ssl=YES"
      And the file should contain "force_local_data_ssl=NO"
      And the file should contain "force_local_logins_ssl=NO"
      And the file should contain "ssl_sslv2=YES"
      And the file should contain "ssl_sslv3=YES"
      And the file should contain "ssl_tlsv1=NO"
      And the file should contain "ca_certs_file=/tmp/certs"
      And the file should contain "validate_cert=YES"
      And the file should contain "strict_ssl_read_eof=YES"
      And the file should contain "strict_ssl_write_shutdown=YES"
      And the file should contain "rsa_cert_file=/tmp/cert.pem"
      And the file should contain "rsa_private_key_file=/tmp/prv.pem"
      And the file should contain "dsa_cert_file=/tmp/cert.pem"
      And the file should contain "dsa_private_key_file=/tmp/prv.pem"
      And the file should contain "ssl_ciphers=3DES"

    And file "/etc/default/vsftpd" should be "present"
    And following directories should be created:
      | name          |
      | /etc/vsftpd.d |
    And file "/etc/vsftpd.d/vsftpd.chroot_users" should be "present"
      And the file should contain "foo"
      And the file should contain "bar"
      And the file should contain "baz"
    And file "/etc/vsftpd.d/vsftpd.banned_emails" should be "present"
      And the file should contain "evil@hacker.com"
    And file "/etc/vsftpd.d/vsftpd.email_passwords" should be "present"
      And the file should contain "easy"
      And the file should contain "pass"
    And file "/etc/vsftpd.d/vsftpd.userlist_file" should be "present"
      And the file should contain "fred"
      And the file should contain "jane"
      And the file should contain "john"

    Scenario: vsftpd::config no parameters
    Given a node named "vsftpd-config-no-params"
    When I try to compile the catalog
    Then compilation should fail
