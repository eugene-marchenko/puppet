#
sub sec_dailybeast_sev1 {
  set req.http.X-VSF-Severity = "1";
  error 404 "Not Found";
}

sub sec_dailybeast_banned {
  set req.http.X-VSF-Severity = "1";
  error 403 "U bannd. Sorry kthxbye.";
}

sub sec_dailybeast_readonly {
  error 405 "Method Not Allowed";
}
<% if @env == "prod" -%>
<% $dark_sign = "< 100" -%>
<% $cond_sign = "||" -%>
<% else $dark_sign = "< 100" -%>
<% $cond_sign = "||" -%>
<% end -%>

  sub security_dailybeast {
    if (req.url ~ "^(/content/dailybeast)?/galleries*(.json$)?") {
      set req.http.x-locus = "gaiamobgall";
    } elsif (req.http.x-locus ~ "gaia-cheat" <%= $cond_sign %> req.url ~ "^/cheats") {
      set req.http.x-locus = "gaia-cheat";
    } elsif (req.url ~ "^/cheat-sheet.html" && std.random(0,99) <%= $dark_sign %>) {
      set req.http.x-locus = "gaia-cheat-sheet";
    } else {
      set req.http.x-locus = "gaia";
  }

  if ( req.url ~ "^/server-status(\?.*)?$" ) {
    call sec_dailybeast_sev1;
  } elsif ( req.url ~ "\.(export.zip|cgi|pl|rb|py|php|asp|aspx)(\?.*)?$" ) {
    call sec_dailybeast_sev1;
  } elsif ( req.url ~ "^/(crx|system|apps|bin|home|tmp|var)" ) {
    call sec_dailybeast_sev1;
  } elsif ( req.url ~ "^/autodiscover/autodiscover.xml$" ) {
    call sec_dailybeast_sev1;
  } elsif ( req.url ~ "readthis.json$" ) {
    call sec_dailybeast_sev1;
  } elsif ( req.url ~ ".*\/(mraid\.js|false\.html|OVVBeacon\.swf)$") {
    call sec_dailybeast_sev1;
  } elsif ( req.url ~ "^/article" && req.request != "GET" && req.request != "HEAD" && req.request != "PURGE" ) {
    call sec_dailybeast_readonly;
  } elsif ( req.url ~ "^/rest" ) {
    call sec_dailybeast_readonly;
  } elsif ( req.http.user-agent ~ "omgili" ) {
    call sec_dailybeast_banned;
  }
}

sub vcl_hash {
  hash_data(req.http.x-locus);
}
